# 热更新原理

> **参考**
>
> [Webpack 中文网站 - 模块热替换(hot module replacement)](https://www.webpackjs.com/concepts/hot-module-replacement/)
>
> [《看完这篇，面试再也不怕被问 Webpack 热更新》(作者：政采云前端团队)【来源：掘金】](https://juejin.cn/post/6844903953092591630)
>
> [《轻松理解 webpack 热更新原理》(作者：青舟同学)【来源：掘金】](https://juejin.cn/post/6844904008432222215)
>
> [《文件监听和热更新原理分析》(作者：渴二)【来源：掘金】](https://juejin.cn/post/6844904134697549832)
>
> [《webpack 热更新（HMR）实现原理》(作者：Bojue)【来源：知乎】](https://zhuanlan.zhihu.com/p/138446061)

Webpack 的模块热替换是基于 `webpack-dev-server` 的，通过 `HotModuleReplacementPlugin` 或 `--hot` 开启。

> 模块热替换（HMR - hot module replacement）功能会在应用程序运行过程中，替换、添加或删除 模块，而无需重新加载整个页面。主要是通过以下几种方式，来显著加快开发速度：
>
> - 保留在完全重新加载页面期间丢失的应用程序状态。
> - 只更新变更内容，以节省宝贵的开发时间。
> - 在源代码中对 CSS / JS 进行修改，会立刻在浏览器中进行更新，这几乎相当于在浏览器 devtools 直接更改样式。

## 实现原理

1. webpack-dev-server 启动本地服务
   - 启动 webpack，生成 compiler 实例。compiler 上有很多方法，比如可以启动 webpack 所有编译工作，以及监听本地文件的变化。
   - 使用 express 框架启动本地 server，让浏览器可以请求本地的静态资源。
   - 本地 server 启动之后，再去启动 websocket 服务。通过 websocket，可以建立本地服务和浏览器的双向通信。这样就可以实现当本地文件发生变化，立马告知浏览器可以热更新代码。
2. 修改 webpack.config.js 的 entry 配置
   - 这个方法中有 2 段关键性代码。一个是获取 websocket 客户端代码路径，另一个是根据配置获取 webpack 热更新代码路径。
3. 监听 webpack 编译结束
   - 修改好入口配置后，又调用了 setupHooks 方法。这个方法是用来注册监听事件的，监听每次 webpack 编译完成。
   - 当监听到一次 webpack 编译结束，就会调用\_sendStats 方法通过 websocket 给浏览器发送通知，ok 和 hash 事件，这样浏览器就可以拿到最新的 hash 值了，做检查更新逻辑。
4. webpack 监听文件变化
   - 每次修改代码，就会触发编译。说明我们还需要监听本地代码的变化，主要是通过 setupDevMiddleware 方法实现的。
   - 这个方法主要执行了 webpack-dev-middleware 库。
   - 其实就是因为 webpack-dev-server 只负责启动服务和前置准备工作，所有文件相关的操作都抽离到 webpack-dev-middleware 库了，主要是本地文件的编译和输出以及监听，无非就是职责的划分更清晰了。
5. 浏览器接收到热更新的通知
   - webpack 监听到了 webpackHotUpdate 事件，并获取最新了最新的 hash 值，然后终于进行检查更新了。检查更新呢调用的是 module.hot.check 方法。
6. HotModuleReplacementPlugin
7. moudle.hot.check 开始热更新
   - 利用上一次保存的 hash 值，调用 hotDownloadManifest 发送 xxx/hash.hot-update.json 的 ajax 请求；
   - 请求结果获取热更新模块，以及下次热更新的 Hash 标识，并进入热更新准备阶段。
   - 调用 hotDownloadUpdateChunk 发送 xxx/hash.hot-update.js 请求，通过 JSONP 方式。
   - 新编译后的代码是在一个 webpackHotUpdate 函数体内部的。也就是要立即执行 webpackHotUpdate 这个方法。
   - hotAddUpdateChunk 方法会把更新的模块 moreModules 赋值给全局全量 hotUpdate。
   - hotUpdateDownloaded 方法会调用 hotApply 进行代码的替换。
8. hotApply 热更新模块替换
   - 删除过期的模块，就是需要替换的模块
   - 将新的模块添加到 modules 中
   - 通过`__webpack_require__`执行相关模块的代码
