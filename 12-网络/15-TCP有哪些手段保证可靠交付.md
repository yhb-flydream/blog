<!--
 * @Author: yaohebin
 * @Date: 2021-09-06 08:21:01
 * @LastEditTime: 2022-08-20 08:38:47
 * @LastEditors: yaohebin
 * @Description: TCP 有哪些手段保证可靠交付
-->

# TCP 有哪些手段保证可靠交付

> **参考**
>
> [《TCP 的可靠性传输是如何保证的》（作者：前端小时）【来源：知乎】](https://zhuanlan.zhihu.com/p/112317245)
>
> [《TCP 可靠传输：ARQ 协议（停止等待、超时重传、滑动窗口、回退 N 帧、选择重传）》（作者：啊 a 阿花）【来源：CSDN】](https://blog.csdn.net/aaahuahua/article/details/119965804)
>
> [《计算机网络——滑动窗口协议的窗口大小》（作者：Mr_J0304）【来源：CSDN】](https://blog.csdn.net/Mr_J0304/article/details/89599086)
>
> [《解析 TCP 之滑动窗口(动画演示)》（作者：SilentAssassin）【来源：CSDN】](https://blog.csdn.net/yao5hed/article/details/81046945)

[TOC]

## 检验和

通过检验和的方式，接收端可以检测出来数据是否有差错和异常，假如有差错就会直接丢弃 TCP 段，重新发送。TCP 在计算检验和时，会在 TCP 首部加上一个 12 字节的伪首部。检验和总共计算 3 部分：TCP 首部、TCP 数据、TCP 伪首部

## 序列号/确认应答

这个机制类似于问答的形式。发送端发送信息给接收端，接收端会回应一个包，这个包就是应答包。

## 超时重传

超时重传是指发送出去的数据包到接收到确认包之间的时间，如果超过了这个时间会被认为是丢包了，需要重传。

发送端发送信息给接收端，接收端回应消息给发送端，这一来一回的时间就是往返时间；由于网络原因还会有时间偏差成为抖动。

**超时重传的时间 > 往返时间 + 抖动时间**

但是在重发的过程中，假如一个包经过多次的重发也没有收到对端的确认包，那么就会认为接收端异常，强制关闭连接。并且通知应用通信异常强行终止。

## 最大消息长度

在建立 TCP 连接的时候，双方约定一个最大的长度（MSS）作为发送的单位，重传的时候也是以这个单位来进行重传。理想的情况下是该长度的数据刚好不被网络层分块。

## 滑动窗口控制

我们上面提到的超时重传的机制存在效率低下的问题，发送一个包到发送下一个包要经过一段时间才可以。所以我们就想着能不能不用等待确认包就发送下一个数据包呢？这就提出了一个滑动窗口的概念。

窗口的大小就是在无需等待确认包的情况下，发送端还能发送的最大数据量。这个机制的实现就是使用了大量的缓冲区，通过对多个段进行确认应答的功能。通过下一次的确认包可以判断接收端是否已经接收到了数据，如果已经接收了就从缓冲区里面删除数据。

接收端在没有收到自己所期望的序列号数据之前，会对之前的数据进行重复确认。发送端在收到某个应答包之后，又连续 3 次收到同样的应答包，则数据已经丢失了，需要重发。

## 拥塞控制

窗口控制解决了 两台主机之间因传送速率而可能引起的丢包问题，在一方面保证了 TCP 数据传送的可靠性。然而如果网络非常拥堵，此时再发送数据就会加重网络负担，那么发送的数据段很可能超过了最大生存时间也没有到达接收方，就会产生丢包问题。

为此 TCP 引入慢启动机制，先发出少量数据，就像探路一样，先摸清当前的网络拥堵状态后，再决定按照多大的速度传送数据。

此处引入一个拥塞窗口：

发送开始时定义拥塞窗口大小为 1；每次收到一个 ACK 应答，拥塞窗口加 1；而在每次发送数据时，发送窗口取拥塞窗口与接送段接收窗口最小者。

慢启动：在启动初期以指数增长方式增长；设置一个慢启动的阈值，当以指数增长达到阈值时就停止指数增长，按照线性增长方式增加至拥塞窗口；线性增长达到网络拥塞时立即把拥塞窗口置回 1，进行新一轮的“慢启动”，同时新一轮的阈值变为原来的一半。

## 丢弃重复数据
